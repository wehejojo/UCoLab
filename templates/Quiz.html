<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz</title>
    <link rel="stylesheet" href="/static/main.css" />
    <style>
      .selected {
        background-color: #dcdcdc;
      }
    </style>
  </head>

  <body>
    <div class="top-bar">
      <h1 id="session_code">Room #:</h1>
    </div>

    <div id="quiz-container">
      <div class="middle-container">
        <div class="question">
          <h2 id="question-text">Loading...</h2>
        </div>
        <div class="options" id="options-container"></div>
      </div>
    </div>

    <div id="results-container" style="display: none; text-align: center">
      <h2 id="loading-message">
        Finding best teammates based on your skills, interests, and working
        style. This may take a moment...
      </h2>
      <div id="matched-groups" style="display: none; margin-top: 2rem">
        <h2>Here are your best matches</h2>
        <div id="groups-container" class="groups-container" style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
        </div>
      </div>
    </div>

    <div class="bottom-bar">
      <div class="bottom-message">
        <p id="question-count">Question 1 / 5</p>
      </div>

      <div class="bottom-button">
        <button type="button" class="Start">Next</button>
      </div>
    </div>

    <script>
      const questions = [
        {
          id: "q1",
          question: "What is your primary strength in a team?",
          choices: ["Hacker", "Hustler", "Hipster", "Explorer"],
        },
        {
          id: "q2",
          question: "What type of projects are you most interested in?",
          choices: [
            "Tech & Software",
            "Sustainability",
            "Health & Wellness",
            "Arts & Culture",
            "Business & Finance",
            "Education",
            "Social Impact & Community",
            "Open to Anything",
          ],
        },
        {
          id: "q3",
          question: "How do you prefer to collaborate?",
          choices: [
            "Fast Paced and action-oriented",
            "Structured and planned",
            "Flexible and go-with-the-flow",
            "I adapt to the team's rhythm",
          ],
        },
        {
          id: "q4",
          question: "What energizes you most during a project",
          choices: [
            "Brainstorming new ideas",
            "Seeing tangible progress",
            "Collaborating with others",
            "Solving hard problems",
          ],
        },
        {
          id: "q5",
          question: "How do you usually contribute to a team discussion?",
          choices: [
            "I lead and organize ideas",
            "I analyze and critique proposals",
            "I bring creative, out-of-the-box ideas",
            "Listen and support others' contributions",
          ],
        },
      ];

      let currentIndex = parseInt(localStorage.getItem("currentIndex")) || 0;
      let selectedAnswers = JSON.parse(localStorage.getItem("selectedAnswers")) || {};

      function saveProgress() {
        localStorage.setItem("currentIndex", currentIndex);
        localStorage.setItem("selectedAnswers", JSON.stringify(selectedAnswers));
      }

      async function loadQuestion(index) {
        const q = questions[index];
        document.getElementById("question-text").innerText = q.question;

        const optionsContainer = document.getElementById("options-container");
        optionsContainer.innerHTML = "";

        q.choices.forEach((choice) => {
          const div = document.createElement("div");
          div.className = "option";
          if (selectedAnswers[q.id] === choice) {
            div.classList.add("selected");
          }
          div.onclick = () => selectOption(div, q.id, choice);
          div.innerHTML = `<h2>${choice}</h2>`;
          optionsContainer.appendChild(div);
        });

        document.getElementById("question-count").innerText = `Question ${index + 1} / ${questions.length}`;
      }

      function selectOption(clickedDiv, questionId, answer) {
        document.querySelectorAll(".option").forEach((div) => {
          div.classList.remove("selected");
        });
        clickedDiv.classList.add("selected");
        selectedAnswers[questionId] = answer;
        saveProgress();
      }

      async function getMatches() {
        try {
          const response = await fetch("http://192.168.0.87:5000/match", {
            credentials: "include"
          });
          
          if (!response.ok) {
            throw new Error('Failed to get matches');
          }

          const groups = await response.json();
          return groups;
        } catch (error) {
          console.error("Error getting matches:", error);
          return null;
        }
      }

      function renderGroups(groups) {
        const container = document.getElementById("groups-container");
        container.innerHTML = "";

        Object.entries(groups).forEach(([groupName, groupData]) => {
          const members = groupData.members;
          
          Object.entries(members).forEach(([name, data]) => {
            const card = document.createElement("div");
            card.className = "card";
            
            const role = data.skills[0]; // First skill is the role (q1)
            const interest = data.skills[1]; // Second skill is interest (q2)
            
            card.innerHTML = `
              <h3>${role}</h3>
              <div class="card-bottom">
                <h2>${name}</h2>
                <p>Interest</p>
                <div class="interests">
                  <p>${interest}</p>
                </div>
                <p>Working Style</p>
                <div class="skills">
                  <p>${data.skills[2]}</p>
                  <p>${data.skills[3]}</p>
                  <p>${data.skills[4]}</p>
                </div>
              </div>
            `;
            
            container.appendChild(card);
          });
        });
      }

      async function nextQuestion() {
        const currentQuestionId = questions[currentIndex].id;
        const answer = selectedAnswers[currentQuestionId];

        if (!answer) {
          alert("Please select an answer before proceeding.");
          return;
        }

        try {
          const response = await fetch("http://192.168.0.87:5000/submit-answer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ question_id: currentQuestionId, answer }),
          });

          if (!response.ok) {
            throw new Error('Failed to submit answer');
          }
        } catch (error) {
          console.error("Error submitting answer:", error);
          alert("Failed to submit answer. Please try again.");
          return;
        }

        if (currentIndex < questions.length - 1) {
          currentIndex++;
          saveProgress();
          loadQuestion(currentIndex);
        } else {
          // Quiz finished
          localStorage.clear();
          document.getElementById("quiz-container").style.display = "none";
          const results = document.getElementById("results-container");
          results.style.display = "block";
          results.className = "results";

          // Hide the bottom bar
          document.querySelector(".bottom-bar").style.display = "none";

          // Wait for all users to complete and get matches
          const checkForMatches = async () => {
            const matches = await getMatches();
            if (matches && !matches.error) {
              document.getElementById("loading-message").style.display = "none";
              document.getElementById("matched-groups").style.display = "block";
              renderGroups(matches);
            } else {
              // If no matches yet, try again in 5 seconds
              setTimeout(checkForMatches, 5000);
            }
          };

          // Start checking for matches
          checkForMatches();
        }
      }

      async function renderRoom() {
        try {
          const response = await fetch("http://192.168.0.87:5000/room_code");
          const result = await response.json();

          if (result.success) {
            document.getElementById("session_code").innerHTML = `Room #: ${result.room_code}`;
          }
        } catch (err) {
          console.error("Failed to fetch room code:", err);
        }
      }

      window.onload = () => {
        renderRoom();
        loadQuestion(currentIndex);

        document.querySelector(".Start").addEventListener("click", (e) => {
          e.preventDefault();
          nextQuestion();
        });
      };
    </script>
  </body>
</html>